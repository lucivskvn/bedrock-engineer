# Bedrock Engineer Agent Guidelines

- **Language policy:** Author code comments and documentation in English unless you are updating a file that is already fully translated (for example `README-ja.md`).
- **Testing discipline:** Run `npm run lint`, `npm run typecheck`, and `npm test` after changes to application code. The wrappers verify the upgraded React 19 / Tailwind CSS 4 toolchain is installed.
- **Native rebuilds:** Dependency installs attempt to rebuild native modules via `scripts/postinstall.mjs`. If lifecycle scripts are skipped or you need a manual retry, run `npm run rebuild:native` once the install step completes. The helper now purges lingering `.app-builder-bin-*` caches before invoking `electron-builder` so stale binaries no longer block installs.
- **Native cache cleanup:** If an `ENOTEMPTY` rename error appears for `app-builder-bin`, run `npm run clean:native` to remove the leftover `.app-builder-bin-*` cache before retrying the install or rebuild.
- **Static log messages:** When adding warnings or errors, keep the message text constant and move request-specific details into the metadata object. Refer to `docs/logging.md` for redaction rules.
- **HTTP observability:** Reuse `createRequestContextMiddleware` (or its helpers) for new Express endpoints so every request carries an `X-Request-Id`, trace/span identifiers, and Prometheus metrics. Never bypass the middleware when adding routers or the logs will lose their correlation context.
- **Renderer toasts:** Keep `toast.success` and `toast.error` strings static. Route contextual details (server names, counts, durations) through the logger metadata rather than interpolating them into the user-facing message.
- **Filesystem tokens:** When logging or throwing errors with filesystem paths, call `toFileToken(path)` first so only `[filename.ext]` placeholders appear in messages and metadata.
- **Media generation tools:** The GenerateImage and GenerateVideo preload tools must tokenise any `outputPath` values with `toFileToken` before logging or raising `ExecutionError` instances so user directories stay redacted. Apply the same rule to DownloadVideo so saved file paths never leak into logs or error payloads.
- **Website fetch tool:** The FetchWebsite preload tool must tokenise any saved file paths with `toFileToken`, keep success and failure strings static, and route detailed diagnostics through metadata (for example `errorName`, `errorMessage`, and directory tokens) instead of interpolating raw values into messages.
- **PDF handlers:** Reuse the `createPdfParser` helper from `src/main/handlers/pdf/utils.ts` so PDF extractions and metadata lookups flow through the new wrapper around `pdf-parse` 2.3.x. The adapter memoises parse results, guards against missing optional dependencies, and ensures structured errors expose only hashed path summaries plus placeholder metadata.
- **PDF parser cache:** The `PDFParse` helper caches the resolved `pdf-parse` export and automatically resets its internal promise whenever parsing fails. Unit tests that stub `pdf-parse` should call `resetPdfParseCacheForTests()` before each assertion run to keep memoised state from leaking across cases.
- **Tavily search tool:** Keep TavilySearch log messages and tool responses static. Log only truncated (â‰¤100 character) query previews inside metadata, avoid dumping the entire Tavily configuration object, and emit the fixed `'Tavily search completed.'` success string while surfacing request context through metadata.
- **Vision recognition tools:** RecognizeImage, ScreenCapture, and CameraCapture must source their fallback model from `DEFAULT_RECOGNIZE_IMAGE_MODEL_ID` and keep failure text fixed to `'Failed to analyze this image.'` while capturing diagnostics through metadata such as `errorName`, `errorCode`, and tokenised paths.
- **ExecuteCommand tool:** Keep `executeCommand` log messages and `ExecutionError` instances static while attaching metadata from the sanitized input helper. Always tokenise working directories with `toFileToken` before logging or raising errors.
- **Error causes:** When throwing errors from preload or main-process code, keep the primary message static and attach sanitised metadata via the `cause` option (for example `{ cause: { fileName: '[image.png]' } }`). The tool wrappers log `error.cause` automatically, so avoid embedding paths or IDs in the message string.
- **Execution errors:** Prefer `ExecutionError` (or helpers such as `createFileExecutionError`) for tool failures so the message stays static while contextual details live in the metadata/cause payload.
- **Nova Sonic streaming:** The bidirectional streaming client relies on a `createSonicError` helper to produce static messages such as `'Nova Sonic stream session not found.'` and `'Nova Sonic tool execution failed.'`. When adding new session lifecycle branches, surface `sessionId`, retry hints, or tool details via `cause` metadata instead of interpolating them into the message.
- **Nova Sonic region checks:** Reuse the constants in `src/common/sonic/regions.ts` so both the main-process endpoints and renderer helpers emit the fixed availability strings. Keep `RegionCheckResult.error` and connectivity test failures set to the exported static messages while logging request-specific details through metadata.
- **Renderer icons:** Clone or restyle icons through `getIconByValue` from `src/renderer/src/components/icons/AgentIcons.tsx` instead of calling `React.cloneElement` directly. The helper ensures React 19-compatible typings and consistent styling overrides.
- **Date placeholders:** Use format tokens such as `YYYY-MM-DD` or `YYYY-MM-DDTHH:MM:SSZ` in user-facing examples. Avoid embedding hard-coded calendar years in error or warning copy.
- **ESM dependencies:** Load ESM-only Node packages from the main/preload layers with `await import(...)` helpers (see `electron.vite.config.ts` and `src/main/lib/proxy-utils.ts`) so TypeScript keeps the generated code compatible with `moduleResolution: nodenext`.
