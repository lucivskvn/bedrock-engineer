<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camera Preview</title>
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' https: data:"
    />
    <link rel="stylesheet" href="camera-preview.css" />
  </head>
  <body>
    <div class="preview-container" id="previewContainer">
      <!-- ドラッグハンドル -->
      <div class="drag-handle"></div>

      <!-- コントロールオーバーレイ -->
      <div class="controls-overlay">
        <button class="control-button" id="settingsBtn" title="Settings">⚙️</button>
        <button class="control-button" id="closeBtn" title="Close">✕</button>
      </div>

      <!-- ステータスインジケーター -->
      <div class="status-indicator status-default" id="statusIndicator"></div>

      <!-- ビデオストリーム -->
      <video class="video-stream" id="videoStream" autoplay muted playsinline></video>

      <!-- ローディングメッセージ -->
      <div class="loading-message" id="loadingMessage">
        <div class="loading-spinner"></div>
        <div>Starting camera...</div>
      </div>

      <!-- エラーメッセージ -->
      <div class="error-message hidden" id="errorMessage">
        <div>Camera access failed</div>
        <div class="error-details" id="errorDetails"></div>
      </div>

      <!-- カメラ情報 -->
      <div class="camera-info" id="cameraInfo">
        <div id="cameraName">Camera Preview</div>
        <div id="cameraResolution"></div>
      </div>
    </div>

    <script>
      const log = window.logger.createCategoryLogger('camera-preview')
      class CameraPreview {
        constructor() {
          this.videoElement = document.getElementById('videoStream')
          this.loadingMessage = document.getElementById('loadingMessage')
          this.errorMessage = document.getElementById('errorMessage')
          this.errorDetails = document.getElementById('errorDetails')
          this.statusIndicator = document.getElementById('statusIndicator')
          this.cameraInfo = document.getElementById('cameraInfo')
          this.cameraName = document.getElementById('cameraName')
          this.cameraResolution = document.getElementById('cameraResolution')

          this.currentStream = null
          this.isInitialized = false

          this.init()
        }

        async init() {
          try {
            // イベントリスナーを設定
            this.setupEventListeners()

            // カメラストリームを開始
            await this.startCameraStream()

            this.isInitialized = true
          } catch (error) {
            log.error('Failed to initialize camera preview:', error)
            this.showError('Initialization failed', error.message)
          }
        }

        setupEventListeners() {
          // 閉じるボタン
          document.getElementById('closeBtn').addEventListener('click', async () => {
            this.cleanup()

            // URLパラメータからdeviceIdを取得して個別ウィンドウクローズを実行
            const urlParams = new URLSearchParams(window.location.search)
            const deviceId = urlParams.get('deviceId') || 'default'

            try {
              log.debug('Attempting to close individual preview window:', deviceId)
              const result = await window.api.camera.closePreviewWindow(deviceId)

              if (result.success) {
                log.debug('Individual window close result:', result.message)
                // ウィンドウが正常に閉じられるとclosedイベントが発火され、自動的に削除される
              } else {
                log.error('Failed to close individual window:', result.message)
                // フォールバックとして全体を閉じる
                await this.fallbackClose()
              }
            } catch (error) {
              log.error('Error during individual window close:', error)
              // エラー時のフォールバック
              await this.fallbackClose()
            }
          })

          // 設定ボタン（将来の拡張用）
          document.getElementById('settingsBtn').addEventListener('click', () => {
            // 将来的にここで設定パネルを表示
            log.debug('Settings clicked')
          })

          // ウィンドウが閉じられる時のクリーンアップ
          window.addEventListener('beforeunload', () => {
            this.cleanup()
          })

          // ビデオ要素のイベント
          this.videoElement.addEventListener('loadedmetadata', () => {
            this.onStreamLoaded()
          })

          this.videoElement.addEventListener('error', (error) => {
            log.error('Video element error:', error)
            this.showError('Video playback failed', 'Unable to display camera stream')
          })
        }

        async startCameraStream() {
          try {
            this.showLoading()

            // URLパラメータからdeviceIdとdeviceNameを取得
            const urlParams = new URLSearchParams(window.location.search)
            const targetDeviceId = urlParams.get('deviceId')
            const targetDeviceName = urlParams.get('deviceName')

            log.info('Starting camera stream for:', {
              deviceId: targetDeviceId,
              deviceName: targetDeviceName
            })

            // カメラタイトルを更新
            if (targetDeviceName) {
              this.cameraName.textContent = decodeURIComponent(targetDeviceName)
              document.title = `Camera Preview - ${decodeURIComponent(targetDeviceName)}`
            }

            // getUserMedia APIでカメラストリームを取得
            const constraints = {
              video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                frameRate: { ideal: 30, max: 30 }
              },
              audio: false
            }

            // 特定のdeviceIdが指定されている場合は制約に追加
            if (targetDeviceId && targetDeviceId !== 'default') {
              constraints.video.deviceId = { exact: targetDeviceId }
              log.info('Using specific camera device:', targetDeviceId)
            } else {
              log.info('Using default camera device')
            }

            this.currentStream = await navigator.mediaDevices.getUserMedia(constraints)
            this.videoElement.srcObject = this.currentStream

            // デバイス情報を取得
            await this.updateCameraInfo()
          } catch (error) {
            log.error('Camera access failed:', error)

            // 特定のデバイスIDでの取得に失敗した場合、デフォルトカメラにフォールバック
            if (error.name === 'OverconstrainedError' || error.name === 'NotFoundError') {
              log.info('Falling back to default camera...')
              try {
                const fallbackConstraints = {
                  video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    frameRate: { ideal: 30, max: 30 }
                  },
                  audio: false
                }

                this.currentStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints)
                this.videoElement.srcObject = this.currentStream
                await this.updateCameraInfo()

                // フォールバック警告を表示
                this.showWarning(
                  'Using default camera',
                  'Specified camera not available, using default camera instead'
                )
              } catch (fallbackError) {
                log.error('Fallback camera access also failed:', fallbackError)
                this.showError('Camera access failed', this.getErrorMessage(fallbackError))
              }
            } else {
              this.showError('Camera access failed', this.getErrorMessage(error))
            }
          }
        }

        async updateCameraInfo() {
          try {
            if (!this.currentStream) return

            const videoTrack = this.currentStream.getVideoTracks()[0]
            if (!videoTrack) return

            const settings = videoTrack.getSettings()
            const devices = await navigator.mediaDevices.enumerateDevices()
            const videoDevices = devices.filter((device) => device.kind === 'videoinput')

            const currentDevice = videoDevices.find(
              (device) => device.deviceId === settings.deviceId
            )

            if (currentDevice) {
              this.cameraName.textContent = currentDevice.label || 'Camera'
            }

            if (settings.width && settings.height) {
              this.cameraResolution.textContent = `${settings.width}×${settings.height}`
            }
          } catch (error) {
            log.error('Failed to update camera info:', error)
          }
        }

        onStreamLoaded() {
          this.hideLoading()
          this.hideError()
          this.updateStatus('active')
        }

        showLoading() {
          this.loadingMessage.classList.remove('hidden')
          this.errorMessage.classList.add('hidden')
          this.updateStatus('loading')
        }

        hideLoading() {
          this.loadingMessage.classList.add('hidden')
        }

        showError(title, details) {
          this.loadingMessage.classList.add('hidden')
          this.errorMessage.classList.remove('hidden')
          this.errorMessage.firstElementChild.textContent = title
          this.errorDetails.textContent = details
          this.updateStatus('error')
        }

        showWarning(title, details) {
          log.warn(`${title}: ${details}`)
          // 警告は一時的に表示して自動で消える
          const warningElement = this.errorMessage.cloneNode(true)
          warningElement.classList.add('warning-message')
          warningElement.classList.remove('hidden')
          warningElement.firstElementChild.textContent = title
          warningElement.children[1].textContent = details

          this.loadingMessage.classList.add('hidden')
          this.errorMessage.classList.add('hidden')

          // 警告要素を一時的に追加
          document.getElementById('previewContainer').appendChild(warningElement)

          // 3秒後に警告を自動で非表示
          setTimeout(() => {
            if (warningElement.parentNode) {
              warningElement.parentNode.removeChild(warningElement)
            }
            this.updateStatus('active')
          }, 3000)

          this.updateStatus('warning')
        }

        hideError() {
          this.errorMessage.classList.add('hidden')
        }

        updateStatus(status) {
          const classes = ['status-active', 'status-loading', 'status-error', 'status-default']
          this.statusIndicator.classList.remove(...classes)
          switch (status) {
            case 'active':
              this.statusIndicator.classList.add('status-active')
              break
            case 'loading':
              this.statusIndicator.classList.add('status-loading')
              break
            case 'error':
              this.statusIndicator.classList.add('status-error')
              break
            default:
              this.statusIndicator.classList.add('status-default')
          }
        }

        getErrorMessage(error) {
          if (error.name === 'NotAllowedError') {
            return 'Camera permission denied. Please allow camera access in your browser settings.'
          } else if (error.name === 'NotFoundError') {
            return 'No camera device found. Please connect a camera and try again.'
          } else if (error.name === 'NotReadableError') {
            return 'Camera is already in use by another application.'
          } else if (error.name === 'OverconstrainedError') {
            return 'Camera does not support the requested configuration.'
          } else {
            return error.message || 'Unknown camera error occurred.'
          }
        }

        async fallbackClose() {
          try {
            log.debug('Attempting fallback close using hidePreviewWindow')
            const result = await window.api.camera.hidePreviewWindow()

            if (result.success) {
              log.debug('Fallback close successful:', result.message)
            } else {
              log.error('Fallback close failed:', result.message)
              // 最後の手段として、ウィンドウを直接閉じる
              window.close()
            }
          } catch (error) {
            log.error('Fallback close error:', error)
            // 最後の手段として、ウィンドウを直接閉じる
            window.close()
          }
        }

        cleanup() {
          if (this.currentStream) {
            this.currentStream.getTracks().forEach((track) => {
              track.stop()
            })
            this.currentStream = null
          }

          if (this.videoElement) {
            this.videoElement.srcObject = null
          }
        }
      }

      // カメラプレビューを初期化
      document.addEventListener('DOMContentLoaded', () => {
        new CameraPreview()
      })
    </script>
  </body>
</html>
